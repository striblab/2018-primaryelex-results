<!-- TODO: Standarize on "office" not "race" -->
<div class="race cf type-{ voteType } { partisan ? 'partisan' : 'nonpartisan' }" id="{ id }">
  {#if !loaded}
    <div class="loading office-loading">Loading...</div>
  {:else}
    <h3 class="font-benton-sans">{ title }</h3>

    {#each contests as contest}
      {#if !parties || (parties && ~parties.indexOf(contest.party.id))}
        <Contest id="{ contest.id }" {...contest} embedded="{ true }" loaded="{ loaded }" />
      {/if}
    {/each}
  {/if}
</div>

<script>
  // Dependencies and components
  import Contest from "./_content-contest.svelte.html";
  import { isArray } from "lodash";

  // Svelte logic
  export default {
    components: {
      Contest
    },

    oncreate() {
      this.fetchData();
    },

    methods: {
      fetchData() {
        // TODO: Handle no ID
        if (!this.get().id) {
          return;
        }

        // If embedded, data is managed some other way
        if (this.get().embedded) {
          return;
        }

        // Mark as loading
        this.set({ loading: true });

        // Fetch
        window
          .fetch(
            `${this.store.get().civixEndpoint}/contests/by-office/${
              this.get().id
            }.json`
          )
          .then(response => {
            return response.json();
          })
          .then(office => {
            if (isArray(office)) {
              office = {
                contests: office
              };
            }

            this.set(office);
            this.set({ loaded: true, loading: false });
          })
          .catch(e => {
            // TODO: Handle error
            console.error(e);
            this.set({ loading: false });
          });
      }
    }
  };
</script>