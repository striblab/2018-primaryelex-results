<!-- TODO: Standarize on "office" not "race" -->
<div class="race cf type-{ voteType } { partisan ? 'partisan' : 'nonpartisan' }" id="{ id }">
  <h4 class="font-benton-sans">{ title || '-' }</h4>
  <div class="office-details">
    <p class="timestamp">Last updated: { updatedDate ? makeDate(updatedDate) : '-' }</p>
    <p class="office-chat">Let's put a touch more of the magic here. Get away from those little Christmas tree things we used to make in school. Every highlight needs it's own personal shadow. Follow the lay of the land. It's most important.</p>
  </div>

  {#if !loaded}
    {#each (new Array(2)) as blank}
      <Contest embedded="{ true }" loaded="{ false }" />
    {/each}
  {:else}
    {#each contests as contest}
      {#if !parties || (parties && ~parties.indexOf(contest.party.id))}
        <Contest id="{ contest.id }" {...contest} embedded="{ true }" loaded="{ loaded }" />
      {/if}
    {/each}
  {/if}
</div>

<script>
  // Dependencies and components
  import Contest from "./_content-contest.svelte.html";
  import { isArray } from "lodash";

  // Svelte logic
  export default {
    components: {
      Contest
    },

    oncreate() {
      this.fetchData();
    },

    helpers: {
      makeDate: date => {
        return date.toString();
      }
    },

    computed: {
      updatedDate: ({ contests }) => {
        if (!contests) {
          return;
        }

        // TODO: Get newest/oldest date
        return (
          contests[0].results[0].apUpdated || contests[0].results[0].last_updated
        );
      }
    },

    methods: {
      fetchData() {
        // TODO: Handle no ID
        if (!this.get().id) {
          return;
        }

        // If embedded, data is managed some other way
        if (this.get().embedded) {
          return;
        }

        // Mark as loading
        this.set({ loading: true });

        // Fetch
        window
          .fetch(
            `${this.store.get().civixEndpoint}/contests/by-office/${
              this.get().id
            }.json`
          )
          .then(response => {
            return response.json();
          })
          .then(office => {
            if (isArray(office)) {
              office = {
                contests: office
              };
            }

            this.set(office);
            this.set({ loaded: true, loading: false });
          })
          .catch(e => {
            // TODO: Handle error
            console.error(e);
            this.set({ loading: false });
          });
      }
    }
  };
</script>
