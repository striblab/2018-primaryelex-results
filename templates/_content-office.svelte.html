<!-- TODO: Standarize on "office" not "race" -->
<div class="race cf type-{ voteType } { partisan ? 'partisan' : 'nonpartisan' }" id="{ id }">
  {#if !loaded}
    <div class="loading office-loading">
        <div class="race-party-table">
        <table>
          <thead>
            <tr>
              <th></th>
              <th class="cand">Candidates</th>
              <th class="votes">Votes</th>
              <th class="pct">Pct.</th>
              <th class="bar"></th>
            </tr>
          </thead>
          <tbody>
              <tr>
                <td class="winner"></td>
                <td class="cand">Loading ...</td>
                <td class="votes"></td>
                <td class="pct">%</td>
                <td class="bar"></td>
              </tr>
              <tr>
                <td class="winner"></td>
                <td class="cand">Loading ...</td>
                <td class="votes"></td>
                <td class="pct">%</td>
                <td class="bar"></td>
              </tr>
              <tr>
                <td class="winner"></td>
                <td class="cand">Loading ...</td>
                <td class="votes"></td>
                <td class="pct">%</td>
                <td class="bar"></td>
              </tr>
          </tbody>
        </table>
      </div>
      <div class="race-party-table">
        <table>
          <thead>
            <tr>
              <th></th>
              <th class="cand">Candidates</th>
              <th class="votes">Votes</th>
              <th class="pct">Pct.</th>
              <th class="bar"></th>
            </tr>
          </thead>
          <tbody>
              <tr>
                <td class="winner"></td>
                <td class="cand">Loading ...</td>
                <td class="votes"></td>
                <td class="pct">%</td>
                <td class="bar"></td>
              </tr>
              <tr>
                <td class="winner"></td>
                <td class="cand">Loading ...</td>
                <td class="votes"></td>
                <td class="pct">%</td>
                <td class="bar"></td>
              </tr>
              <tr>
                <td class="winner"></td>
                <td class="cand">Loading ...</td>
                <td class="votes"></td>
                <td class="pct">%</td>
                <td class="bar"></td>
              </tr>
          </tbody>
        </table>
      </div>
    </div>
  {:else}
    <h4 class="font-benton-sans">{ title }</h4>
    <div class="office-details">
      <p class="timestamp">Last updated: </p>
      <p class="office-chat">Let's put a touch more of the magic here. Get away from those little Christmas tree things we used to make in school. Every highlight needs it's own personal shadow. Follow the lay of the land. It's most important.</p>
    </div>
    {#each contests as contest}
      {#if !parties || (parties && ~parties.indexOf(contest.party.id))}
        <Contest id="{ contest.id }" {...contest} embedded="{ true }" loaded="{ loaded }" />
      {/if}
    {/each}
  {/if}
</div>

<script>
  // Dependencies and components
  import Contest from "./_content-contest.svelte.html";
  import { isArray } from "lodash";

  // Svelte logic
  export default {
    components: {
      Contest
    },

    oncreate() {
      this.fetchData();
    },

    methods: {
      fetchData() {
        // TODO: Handle no ID
        if (!this.get().id) {
          return;
        }

        // If embedded, data is managed some other way
        if (this.get().embedded) {
          return;
        }

        // Mark as loading
        this.set({ loading: true });

        // Fetch
        window
          .fetch(
            `${this.store.get().civixEndpoint}/contests/by-office/${
              this.get().id
            }.json`
          )
          .then(response => {
            return response.json();
          })
          .then(office => {
            if (isArray(office)) {
              office = {
                contests: office
              };
            }

            this.set(office);
            this.set({ loaded: true, loading: false });
          })
          .catch(e => {
            // TODO: Handle error
            console.error(e);
            this.set({ loading: false });
          });
      }
    }
  };
</script>