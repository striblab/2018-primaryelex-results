<!-- TODO: Standardize on "body" term -->
<div class="race-level" id="{ id }">
  <div class="race-group">
    {#if !loaded}
      <div class="loading contest-loading">
        <div class="race-party-table">
        <table>
          <thead>
            <tr>
              <th></th>
              <th class="cand">Candidates</th>
              <th class="votes">Votes</th>
              <th class="pct">Pct.</th>
              <th class="bar"></th>
            </tr>
          </thead>
          <tbody>
              <tr>
                <td class="winner"></td>
                <td class="cand">Loading ...</td>
                <td class="votes"></td>
                <td class="pct">%</td>
                <td class="bar"></td>
              </tr>
              <tr>
                <td class="winner"></td>
                <td class="cand">Loading ...</td>
                <td class="votes"></td>
                <td class="pct">%</td>
                <td class="bar"></td>
              </tr>
              <tr>
                <td class="winner"></td>
                <td class="cand">Loading ...</td>
                <td class="votes"></td>
                <td class="pct">%</td>
                <td class="bar"></td>
              </tr>
          </tbody>
        </table>
      </div>
      <div class="race-party-table">
        <table>
          <thead>
            <tr>
              <th></th>
              <th class="cand">Candidates</th>
              <th class="votes">Votes</th>
              <th class="pct">Pct.</th>
              <th class="bar"></th>
            </tr>
          </thead>
          <tbody>
              <tr>
                <td class="winner"></td>
                <td class="cand">Loading ...</td>
                <td class="votes"></td>
                <td class="pct">%</td>
                <td class="bar"></td>
              </tr>
              <tr>
                <td class="winner"></td>
                <td class="cand">Loading ...</td>
                <td class="votes"></td>
                <td class="pct">%</td>
                <td class="bar"></td>
              </tr>
              <tr>
                <td class="winner"></td>
                <td class="cand">Loading ...</td>
                <td class="votes"></td>
                <td class="pct">%</td>
                <td class="bar"></td>
              </tr>
          </tbody>
        </table>
      </div>
    </div>
    {:else}
      <h3 class="font-benton-sans">{ title }</h3>

      {#each Object.entries(offices) as [officeId, office]}
        <Office id="{ officeId }" {...office} parties="{ parties }" embedded="{ true }" loaded="{ loaded }" />
      {/each}
    {/if}
  </div>
</div>

<script>
  // Dependencies and components
  import Office from "./_content-office.svelte.html";
  import { groupBy, isArray, mapValues } from "lodash";

  // Svelte logic
  export default {
    components: {
      Office
    },

    oncreate() {
      this.fetchData();
    },

    methods: {
      fetchData() {
        // TODO: Handle no ID
        if (!this.get().id) {
          return;
        }

        // If embedded, data is managed some other way
        if (this.get().embedded) {
          return;
        }

        // Mark as loading
        this.set({ loading: true });

        // Fetch
        window
          .fetch(
            `${this.store.get().civixEndpoint}/contests/by-body/${
              this.get().id
            }.json`
          )
          .then(response => {
            return response.json();
          })
          .then(body => {
            if (isArray(body)) {
              body = {
                offices: mapValues(groupBy(body, "office_id"), g => {
                  return { contests: g };
                })
              };
            }

            this.set(body);
            this.set({ loaded: true, loading: false });
          })
          .catch(e => {
            // TODO: Handle error
            console.error(e);
            this.set({ loading: false });
          });
      }
    }
  };
</script>
