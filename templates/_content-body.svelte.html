<!-- TODO: Standardize on "body" term -->
<div class="race-level" id="C">
  <div class="race-group">
    {#if !loaded}
      <div class="loading contest-loading">Loading...</div>
    {:else}
      <h3 class="font-benton-sans">{ title }</h3>

      {#each Object.entries(bodies) as [officeId, office]}
        <Office id="{ officeId }" parties="{ parties }" />
      {/each}
    {/if}
  </div>
</div>

<script>
  // Dependencies and components
  import Office from "./_content-office.svelte.html";
  import { groupBy } from "lodash";

  // Svelte logic
  export default {
    components: {
      Office
    },

    oncreate() {
      // TODO: Handle no ID
      if (!this.get().id) {
        return;
      }

      window
        .fetch(
          `//static.startribune.com/elections/civix/mn-20180814/bodies/${
            this.get().id
          }.json`
        )
        .then(response => {
          return response.json();
        })
        .then(body => {
          this.set({
            // Group by office
            bodies: groupBy(body, b => b.office.id),
            // TODO: Get body title (needs API update)
            title: body[0].office.body_id,
            loaded: true
          });
        })
        .catch(e => {
          // TODO: Handle error
          console.error(e);
        });
    }
  };
</script>
